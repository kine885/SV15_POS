<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS Screen</title>
  <script src="sweetalert.js"></script>
  <script src="tailwind.js"></script>
</head>
<body class="bg-gray-100">
  <div class="flex ">
    <!-- product selection -->
    <div class="w-7/12 p-0 max-h-[600px] m-3 ">
      <!-- main product card -->
      <div class="grid grid-cols-4 gap-4" id="main_product_card">
      </div>
    </div>
    <!-- pos system menu -->
    <div class="w-5/12 p-0 m-3 rounded-lg bg-gray-200 drop-shadow-lg">
      <h2 class="text-2xl font-bold text-left text-black-100 p-4">Select Product</h2>
      <!-- product output table -->
      <div class="w-full py-2">
          <table class="w-full text-sm text-left">
              <thead class=" bg-blue-400 text-white text-xs ">
                <tr class="[&>th]:p-2">
                    <th>No.</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Action</th>
                </tr>
              </thead>
              <tbody class="text-black text-xs bg-gray-300" id="selected_tr">
              </tbody>
          </table>
      </div>
      <!-- Total -->
      <div class="p-4 flex md:items-center justify-between border border-gray-400">
          <h1 class="text-2xl text-black ">Total:</a>
          <h1 class="text-2xl" id="total_usd">0.00$</h1>
          <h1 class="text-2xl" id="total_khr">0·üõ</h1>
      </div>
      <!-- Received -->
      <div class="p-4 flex md:items-center justify-between border border-gray-400">
        <h1 class="text-2xl text-black" >Received:</h1>
        <input type="number" id="received" onkeyup="getChangeAmount()" class="text-3xl text-red-800">
      </div>
      <!-- changed -->
     <div class="p-4 flex md:items-center justify-between border border-gray-400">
        <h1 class="text-2xl text-black">Change:</h1>
        <h1 class="text-4xl text-white px-4 py-2 w-72 rounded text-center" id="changed_amount"></h1>
      </div>
      <!-- btn cancel -->
      <div class="p-4 flex md:items-center justify-between">
        <input type="button" class="bg-red-600 h-10 w-20 text-white rounded text-2xl" onclick="cancelProduct()" value="Cancel" id="btn_cancel"></input>
        <input type="button" class="bg-green-600 h-10 w-20 text-white rounded text-2xl" value="Pay" id="btn_pay"></input>
      </div>
    </div>
  </div>
</body>
<script>
  let product_array = JSON.parse(localStorage.getItem('product_array') ?? '[]')
  let main_product_card = document.getElementById('main_product_card')
  let selected_tr = document.getElementById('selected_tr')
  let input_received = document.getElementById('received')
  let btn_pay = document.getElementById('btn_pay')
  let btn_cancel = document.getElementById('btn_cancel')
  let selected_product = []
  let total = 0
  renderProductCard()
  function renderProductCard(){
    let html_card = ''
    product_array.forEach((product, index) =>{
      //select product
      html_card += `
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm drop-shadow-lg" onclick="cardOnClick(${index})">
          <div class="h-48" >
            <img class="w-full h-full object-contain" src="${product.profile}" alt="Coca" />
          </div>
          <div class="p-4 justify-between">
            <h5 class="text-xl font-semibold text-gray-900">${product.name}</h5>
            <p class="text-gray-700 text-xs">${product.price + "$"}</p>
          </div>
        </div>
      `
    })
    //for updating product
     main_product_card.innerHTML = html_card
  }
  function cardOnClick(index){
    let current_product = product_array[index]
    let dpl_index = null
    for (i = 0; i<selected_product.length; i++){
      if(current_product.name == selected_product[i].name){
        dpl_index = i
        break
      }
    }
    if (dpl_index != null){
      selected_product[dpl_index].quantity += 1
    }
    else{
      current_product.quantity = 1
      selected_product.push(current_product)
    }
    renderSeletecProduct()
    Total()
  }
  function deleteItem(index){
      swal({
  title: "Do you want to delete?",
  text: "Once deleted, you will not be able to recover your data!",
  icon: "warning",
  buttons: true,
  dangerMode: true,
})
.then((willDelete) => {
  if (willDelete) {
    swal("Your item have been delete", {
      icon: "success",
    });
    selected_product.splice(index, 1)
    renderSeletecProduct()
  } else {
    swal("Your Items are safe!");
  }
});
}
  function renderSeletecProduct(){
    let selected_product_tr = ''
    selected_product.forEach((product, index) =>{
      let total_product = product.price * product.quantity
      selected_product_tr += `
         <tr class="[&>td]:p-2" >
              <td>${index + 1 + "."}</td>
              <td>${product.name}</td>
              <td>${product.price + "$"}</td>
              <td>${product.quantity}</td>
              <td>${total_product +"$"}</td>
              <td>
                <button type="button" onclick="deleteItem(${index})" class=" text-white border-2 border-gray-500 hover:bg-red-600 rounded-lg text-sm px-2 py-1">üóëÔ∏è</button>
              </td>
          </tr>
      `
    })
    // for updating tr
    selected_tr.innerHTML = selected_product_tr
  }
  function Total(){
    total = 0
    selected_product.forEach((product, index) =>{
    total += product.price * product.quantity
    })
    document.getElementById('total_usd').innerText = total.toFixed(2) +"$"
    document.getElementById('total_khr').innerText = (parseFloat(total) *4000).toLocaleString() +"·üõ"
  }
  btn_pay.addEventListener('click', function(){
    let received = input_received.value
    if (parseFloat(received) >= total)
    localStorage.setItem('selected_product', JSON.stringify(selected_product))
    let width = 600
    let height = 600
    let left = (window.screen.width - width) / 2;
    let top = (window.screen.height - height) / 2;
    window.open(
    'invoice.html',
    '_blank',
    `width=600,height=600,
     left=${left},
     top=${top}`
)

  })
  function getChangeAmount(){
    let received = input_received.value
    let label_change_amount = document.getElementById('changed_amount')
    changed_amount = parseFloat(received) - parseFloat(total)
    label_change_amount.innerText = changed_amount.toFixed(2) + "$"
    if (received.trim() == "") {  
      label_change_amount.innerText = "";
      label_change_amount.classList.remove("bg-yellow-500");
    return; 
    }
    if (changed_amount != NaN) {
      label_change_amount.classList.add("bg-yellow-500");
    }
  }
  function cancelProduct(){
     swal({
  title: "Do you want to delete?",
  text: "Once deleted, you will not be able to recover your data!",
  icon: "warning",
  buttons: true,
  dangerMode: true,
})
.then((willDelete) => {
  if (willDelete) {
    swal("Poof! Your imaginary file has been deleted!", {
      icon: "success",
    });
    total = 0
    selected_product = []
    renderSeletecProduct()
    Total()
    document.getElementById('received').value = ""
    let label_change_amount = document.getElementById('changed_amount')
    label_change_amount.innerText = ""
    label_change_amount.classList.remove("bg-yellow-500");
  } else {
    swal("Your imaginary file is safe!");
  }
});
    
  }

</script>
</html>